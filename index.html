<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sklik Metrika – Zadávání dat a reporty</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 20px; }
    .time-interval { margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    .category-header { cursor: pointer; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Sklik Metrika – Zadávání dat</h1>
  
  <!-- Formulář pro zadávání denních dat -->
  <form id="dailyDataForm">
    <div class="mb-3">
      <label for="entryDate" class="form-label">Datum</label>
      <input type="date" class="form-control" id="entryDate" required>
    </div>
    <div class="mb-3">
      <label for="dayOfWeek" class="form-label">Den v týdnu</label>
      <input type="text" class="form-control" id="dayOfWeek" readonly>
    </div>
    <div class="mb-3">
      <label for="dailyBudget" class="form-label">Denní rozpočet (Kč)</label>
      <input type="number" class="form-control" id="dailyBudget" value="333" required>
    </div>
    
    <!-- Kategorie Celkově -->
    <div class="mb-3">
      <h3 class="category-header" data-bs-toggle="collapse" data-bs-target="#overallCollapse">
        Celkově (kliknutím skrýt/ukázat)
      </h3>
      <div id="overallCollapse" class="collapse show">
        <div id="overallData"></div>
      </div>
    </div>
    
    <!-- Kategorie Umístění -->
    <div class="mb-3">
      <h3 class="category-header" data-bs-toggle="collapse" data-bs-target="#placementCollapse">
        Umístění (CPC Max) (kliknutím skrýt/ukázat)
      </h3>
      <div id="placementCollapse" class="collapse show">
        <div id="placementData"></div>
      </div>
    </div>
    
    <!-- Kategorie Téma -->
    <div class="mb-3">
      <h3 class="category-header" data-bs-toggle="collapse" data-bs-target="#topicCollapse">
        Téma (CPC Max) (kliknutím skrýt/ukázat)
      </h3>
      <div id="topicCollapse" class="collapse show">
        <div id="topicData"></div>
      </div>
    </div>
    
    <button type="submit" class="btn btn-primary">Uložit data</button>
  </form>
  
  <hr class="my-4">
  
  <!-- Měsíční (denní) report -->
  <h2>Měsíční report</h2>
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="reportFromDate" class="form-label">Od</label>
      <input type="date" class="form-control" id="reportFromDate">
    </div>
    <div class="col-md-6">
      <label for="reportToDate" class="form-label">Do</label>
      <input type="date" class="form-control" id="reportToDate">
    </div>
  </div>
  <button id="generateReport" class="btn btn-secondary mb-3">Generovat měsíční report (zobrazit)</button>
  <div id="reportResult"></div>
  
  <h3>Export reportu</h3>
  <div class="mb-3">
    <button id="exportDailyCSV" class="btn btn-success mt-2 me-2">Export CSV</button>
    <button id="exportDailyPDF" class="btn btn-danger mt-2">Export PDF</button>
  </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- jsPDF pro export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ---------------------------
// POMOCNÉ FUNKCE
// ---------------------------

// Vrací HTML pro časové intervaly (6:00 - 24:00) pro zadaný prefix (např. overall, placement, topic)
const generateTimeIntervalsHTML = (prefix) => {
  let html = '';
  for(let hour = 6; hour < 24; hour++) {
    let nextHour = hour + 1;
    html += `
      <div class="time-interval">
        <h5>${hour}:00 - ${nextHour}:00</h5>
        <div class="row">
          <div class="col-md-3">
            <label>Celkové prokliky</label>
            <input type="number" class="form-control" id="${prefix}_clicks_${hour}" min="0" value="0">
          </div>
          <div class="col-md-3">
            <label>Celková zobrazení</label>
            <input type="number" class="form-control" id="${prefix}_impressions_${hour}" min="0" value="0">
          </div>
          <div class="col-md-3">
            <label>Intervalové prokliky</label>
            <input type="number" class="form-control" id="${prefix}_interval_clicks_${hour}" min="0" value="0">
          </div>
          <div class="col-md-3">
            <label>Intervalová zobrazení</label>
            <input type="number" class="form-control" id="${prefix}_interval_impressions_${hour}" min="0" value="0">
          </div>
        </div>
        <div class="mt-2">
          <label>Procentuální změna (%)</label>
          <input type="number" class="form-control" id="${prefix}_percentage_${hour}" min="0" value="100">
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="${prefix}_active_${hour}" checked>
          <label class="form-check-label" for="${prefix}_active_${hour}">Aktivní interval</label>
        </div>
      </div>
    `;
  }
  return html;
};

// Vrací český název dne podle zadaného data (YYYY-MM-DD)
const getCzechDayOfWeek = (dateStr) => {
  let date = new Date(dateStr);
  const days = ['Neděle', 'Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota'];
  return days[date.getDay()];
};

// Vrací výchozí data pro kategorii (pro každý interval nastaví 0 a false)
const getDefaultCategory = () => {
  let cat = {};
  for(let hour = 6; hour < 24; hour++){
    cat[hour] = { totalClicks: 0, totalImpressions: 0, intervalClicks: 0, intervalImpressions: 0, percentage: 100, active: false };
  }
  return cat;
};

// Vrací výchozí záznam pro dané datum (pokud pro daný den není zadáno nic)
const getDefaultRecord = (date) => {
  return {
    entryDate: date,
    dayOfWeek: getCzechDayOfWeek(date),
    dailyBudget: 0,
    categories: {
      overall: getDefaultCategory(),
      placement: getDefaultCategory(),
      topic: getDefaultCategory()
    }
  };
};

// Vrací pole dat (ve formátu YYYY-MM-DD) pro všechna data mezi start a end (včetně)
const getDatesInRange = (startDate, endDate) => {
  let dates = [];
  let current = new Date(startDate);
  let end = new Date(endDate);
  while (current <= end) {
    dates.push(current.toISOString().slice(0,10));
    current.setDate(current.getDate() + 1);
  }
  return dates;
};

// ---------------------------
// NASTAVENÍ FORMULÁŘE A ULOŽENÍ DAT
// ---------------------------

// Vložení HTML časových intervalů do sekcí pro všechny kategorie
document.getElementById('overallData').innerHTML = generateTimeIntervalsHTML('overall');
document.getElementById('placementData').innerHTML = generateTimeIntervalsHTML('placement');
document.getElementById('topicData').innerHTML = generateTimeIntervalsHTML('topic');

// Po změně data nastavíme den v týdnu a (pokud existují) načteme uložená data
document.getElementById('entryDate').addEventListener('change', function() {
  let dateVal = this.value;
  if(dateVal) {
    document.getElementById('dayOfWeek').value = getCzechDayOfWeek(dateVal);
    loadDataForDate(dateVal);
  }
});

// Načte data z LocalStorage pro dané datum a předvyplní formulář
const loadDataForDate = (dateVal) => {
  let storedData = localStorage.getItem('sklikData');
  let dataArr = storedData ? JSON.parse(storedData) : [];
  let record = dataArr.find(item => item.entryDate === dateVal);
  if(record) {
    document.getElementById('dailyBudget').value = record.dailyBudget;
    const loadCategoryData = (prefix, catData) => {
      for(let hour = 6; hour < 24; hour++) {
        if(catData[hour]){
          document.getElementById(`${prefix}_clicks_${hour}`).value = catData[hour].totalClicks;
          document.getElementById(`${prefix}_impressions_${hour}`).value = catData[hour].totalImpressions;
          document.getElementById(`${prefix}_interval_clicks_${hour}`).value = catData[hour].intervalClicks;
          document.getElementById(`${prefix}_interval_impressions_${hour}`).value = catData[hour].intervalImpressions;
          document.getElementById(`${prefix}_percentage_${hour}`).value = catData[hour].percentage;
          document.getElementById(`${prefix}_active_${hour}`).checked = catData[hour].active;
        }
      }
    };
    loadCategoryData('overall', record.categories.overall);
    loadCategoryData('placement', record.categories.placement);
    loadCategoryData('topic', record.categories.topic);
  } else {
    // Pokud neexistuje záznam, resetujeme hodnoty u kategorií
    const resetCategoryData = (prefix) => {
      for(let hour = 6; hour < 24; hour++) {
        document.getElementById(`${prefix}_clicks_${hour}`).value = 0;
        document.getElementById(`${prefix}_impressions_${hour}`).value = 0;
        document.getElementById(`${prefix}_interval_clicks_${hour}`).value = 0;
        document.getElementById(`${prefix}_interval_impressions_${hour}`).value = 0;
        document.getElementById(`${prefix}_percentage_${hour}`).value = 100;
        document.getElementById(`${prefix}_active_${hour}`).checked = true;
      }
    };
    resetCategoryData('overall');
    resetCategoryData('placement');
    resetCategoryData('topic');
  }
};

// Uložení (nebo aktualizace) dat do LocalStorage
document.getElementById('dailyDataForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  let entryDate = document.getElementById('entryDate').value;
  let dayOfWeek = document.getElementById('dayOfWeek').value;
  let dailyBudget = document.getElementById('dailyBudget').value;
  if (!entryDate || !dailyBudget) {
    alert('Vyplňte prosím všechny povinné údaje.');
    return;
  }
  
  let dayData = {
    entryDate,
    dayOfWeek,
    dailyBudget,
    categories: {
      overall: {},
      placement: {},
      topic: {}
    }
  };

  const getCategoryData = (prefix) => {
    let catData = {};
    for(let hour = 6; hour < 24; hour++) {
      catData[hour] = {
        totalClicks: parseInt(document.getElementById(`${prefix}_clicks_${hour}`).value) || 0,
        totalImpressions: parseInt(document.getElementById(`${prefix}_impressions_${hour}`).value) || 0,
        intervalClicks: parseInt(document.getElementById(`${prefix}_interval_clicks_${hour}`).value) || 0,
        intervalImpressions: parseInt(document.getElementById(`${prefix}_interval_impressions_${hour}`).value) || 0,
        percentage: parseFloat(document.getElementById(`${prefix}_percentage_${hour}`).value) || 100,
        active: document.getElementById(`${prefix}_active_${hour}`).checked
      };
    }
    return catData;
  };

  dayData.categories.overall = getCategoryData('overall');
  dayData.categories.placement = getCategoryData('placement');
  dayData.categories.topic = getCategoryData('topic');

  let storedData = localStorage.getItem('sklikData');
  let dataArr = storedData ? JSON.parse(storedData) : [];
  let existingIndex = dataArr.findIndex(item => item.entryDate === entryDate);
  if(existingIndex > -1){
    dataArr[existingIndex] = dayData;
  } else {
    dataArr.push(dayData);
  }
  localStorage.setItem('sklikData', JSON.stringify(dataArr));
  
  alert('Data byla uložena.');
});

// ---------------------------
// GENEROVÁNÍ MĚSÍČNÍHO (DENNÍHO) REPORTU – denní přehled
// ---------------------------
document.getElementById('generateReport').addEventListener('click', function() {
  let fromDate = document.getElementById('reportFromDate').value;
  let toDate = document.getElementById('reportToDate').value;
  let storedData = localStorage.getItem('sklikData');
  let dataArr = storedData ? JSON.parse(storedData) : [];
  
  // Pokud jsou zadány oba datové rozsahy, vygenerujeme všechny dny mezi nimi; jinak použijeme pouze dostupné dny
  let dates;
  if(fromDate && toDate) {
    dates = getDatesInRange(fromDate, toDate);
  } else {
    dates = dataArr.map(item => item.entryDate);
    dates = [...new Set(dates)];
    dates.sort();
  }
  
  // Pro každý den získáme záznam (nebo výchozí data)
  let records = dates.map(date => {
    let rec = dataArr.find(item => item.entryDate === date);
    if(!rec) { rec = getDefaultRecord(date); }
    return rec;
  });
  
  // Pro každý den spočítáme součty z kategorie "Celkově"
  let reportRows = [];
  records.forEach(day => {
    let totalClicks = 0, totalImpressions = 0;
    for(let hour = 6; hour < 24; hour++){
      totalClicks += day.categories.overall[hour].totalClicks;
      totalImpressions += day.categories.overall[hour].totalImpressions;
    }
    let cpc = totalClicks > 0 ? (day.dailyBudget / totalClicks).toFixed(2) : "N/A";
    reportRows.push({
      date: day.entryDate,
      dayOfWeek: day.dayOfWeek,
      budget: day.dailyBudget,
      clicks: totalClicks,
      impressions: totalImpressions,
      cpc: cpc
    });
  });
  
  // Vypočítáme průměrné CPC (jen u dnů, kde jsou kliky)
  let sumCpc = 0, countCpc = 0;
  reportRows.forEach(row => {
    if(row.cpc !== "N/A") {
      sumCpc += parseFloat(row.cpc);
      countCpc++;
    }
  });
  let avgCpc = countCpc > 0 ? (sumCpc / countCpc).toFixed(2) : 0;
  
  // Přidáme doporučení: pokud je CPC vyšší než průměr, doporučíme "Boost"
  reportRows = reportRows.map(row => {
    let recommendation = "";
    if(row.cpc === "N/A") {
      recommendation = "Žádné kliky";
    } else if(parseFloat(row.cpc) > avgCpc) {
      recommendation = "Boost";
    }
    return { ...row, recommendation };
  });
  
  // Vykreslíme tabulku
  let reportHTML = `<h4>Měsíční report (denní přehled)</h4>`;
  reportHTML += `<p><strong>Období:</strong> ${fromDate || "od začátku"} - ${toDate || "do konce"}</p>`;
  reportHTML += `<table class="table table-bordered">
                   <thead>
                     <tr>
                       <th>Datum</th>
                       <th>Den</th>
                       <th>Rozpočet (Kč)</th>
                       <th>Prokliky</th>
                       <th>Zobrazení</th>
                       <th>CPC</th>
                       <th>Doporučení</th>
                     </tr>
                   </thead>
                   <tbody>`;
  reportRows.forEach(row => {
    reportHTML += `<tr>
                     <td>${row.date}</td>
                     <td>${row.dayOfWeek}</td>
                     <td>${row.budget}</td>
                     <td>${row.clicks}</td>
                     <td>${row.impressions}</td>
                     <td>${row.cpc}</td>
                     <td>${row.recommendation}</td>
                   </tr>`;
  });
  reportHTML += `</tbody></table>`;
  reportHTML += `<p><strong>Průměrné CPC v období:</strong> ${avgCpc}</p>`;
  document.getElementById('reportResult').innerHTML = reportHTML;
});

// ---------------------------
// EXPORTY REPORTŮ – DENNÍ (MĚSÍČNÍ) REPORT
// ---------------------------

// Export do CSV – každý den jako jeden řádek, sloupce: Datum, Den, Rozpočet, Prokliky, Zobrazení, CPC, Doporučení
document.getElementById('exportDailyCSV').addEventListener('click', function() {
  let fromDate = document.getElementById('reportFromDate').value;
  let toDate = document.getElementById('reportToDate').value;
  let storedData = localStorage.getItem('sklikData');
  let dataArr = storedData ? JSON.parse(storedData) : [];
  let dates;
  if(fromDate && toDate) {
    dates = getDatesInRange(fromDate, toDate);
  } else {
    dates = dataArr.map(item => item.entryDate);
    dates = [...new Set(dates)];
    dates.sort();
  }
  let records = dates.map(date => {
    let rec = dataArr.find(item => item.entryDate === date);
    if(!rec) rec = getDefaultRecord(date);
    return rec;
  });
  
  let csvRows = [];
  csvRows.push("Datum;Den;Rozpočet (Kč);Prokliky;Zobrazení;CPC;Doporučení");
  
  // Vypočítáme denní data
  let sumCpc = 0, countCpc = 0;
  let rows = records.map(day => {
    let totalClicks = 0, totalImpressions = 0;
    for(let hour = 6; hour < 24; hour++){
      totalClicks += day.categories.overall[hour].totalClicks;
      totalImpressions += day.categories.overall[hour].totalImpressions;
    }
    let cpc = totalClicks > 0 ? (day.dailyBudget / totalClicks).toFixed(2) : "N/A";
    if(cpc !== "N/A") { sumCpc += parseFloat(cpc); countCpc++; }
    return { date: day.entryDate, dayOfWeek: day.dayOfWeek, budget: day.dailyBudget, clicks: totalClicks, impressions: totalImpressions, cpc: cpc };
  });
  let avgCpc = countCpc > 0 ? (sumCpc / countCpc).toFixed(2) : 0;
  
  // Přidáme doporučení pro každý den
  rows.forEach(row => {
    let rec = "";
    if(row.cpc === "N/A") {
      rec = "Žádné kliky";
    } else if(parseFloat(row.cpc) > avgCpc) {
      rec = "Boost";
    }
    csvRows.push(`"${row.date}";"${row.dayOfWeek}";"${row.budget}";"${row.clicks}";"${row.impressions}";"${row.cpc}";"${rec}"`);
  });
  
  let csvContent = "\uFEFF" + csvRows.join("\n");
  let encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
  let link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "sklik_monthly_report.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

// Export do PDF – vypíše denní řádky s daty a doporučením
document.getElementById('exportDailyPDF').addEventListener('click', function() {
  let fromDate = document.getElementById('reportFromDate').value;
  let toDate = document.getElementById('reportToDate').value;
  let storedData = localStorage.getItem('sklikData');
  let dataArr = storedData ? JSON.parse(storedData) : [];
  let dates;
  if(fromDate && toDate) {
    dates = getDatesInRange(fromDate, toDate);
  } else {
    dates = dataArr.map(item => item.entryDate);
    dates = [...new Set(dates)];
    dates.sort();
  }
  let records = dates.map(date => {
    let rec = dataArr.find(item => item.entryDate === date);
    if(!rec) rec = getDefaultRecord(date);
    return rec;
  });
  
  let rows = [];
  let sumCpc = 0, countCpc = 0;
  records.forEach(day => {
    let totalClicks = 0, totalImpressions = 0;
    for(let hour = 6; hour < 24; hour++){
      totalClicks += day.categories.overall[hour].totalClicks;
      totalImpressions += day.categories.overall[hour].totalImpressions;
    }
    let cpc = totalClicks > 0 ? (day.dailyBudget / totalClicks).toFixed(2) : "N/A";
    if(cpc !== "N/A") { sumCpc += parseFloat(cpc); countCpc++; }
    rows.push({ date: day.entryDate, dayOfWeek: day.dayOfWeek, budget: day.dailyBudget, clicks: totalClicks, impressions: totalImpressions, cpc: cpc });
  });
  let avgCpc = countCpc > 0 ? (sumCpc / countCpc).toFixed(2) : 0;
  
  // Přidáme doporučení
  rows = rows.map(row => {
    let rec = "";
    if(row.cpc === "N/A") { rec = "Žádné kliky"; }
    else if(parseFloat(row.cpc) > avgCpc) { rec = "Boost"; }
    return { ...row, recommendation: rec };
  });
  
  const { jsPDF } = window.jspdf;
  let doc = new jsPDF();
  doc.setFont("Helvetica", "normal");
  doc.setFontSize(10);
  let rowY = 10;
  doc.text("Měsíční report", 10, rowY);
  rowY += 10;
  doc.text("Období: " + (fromDate || "od začátku") + " - " + (toDate || "do konce"), 10, rowY);
  rowY += 10;
  // Hlavička tabulky
  doc.text("Datum | Den | Rozpočet | Prokliky | Zobrazení | CPC | Doporučení", 10, rowY);
  rowY += 8;
  rows.forEach(row => {
    let line = `${row.date} | ${row.dayOfWeek} | ${row.budget} | ${row.clicks} | ${row.impressions} | ${row.cpc} | ${row.recommendation}`;
    doc.text(line, 10, rowY);
    rowY += 6;
    if(rowY > 280) {
      doc.addPage();
      rowY = 10;
    }
  });
  doc.save("sklik_monthly_report.pdf");
});
});
</script>
</body>
</html>
